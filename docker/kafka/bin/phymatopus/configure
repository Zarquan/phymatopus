#!/bin/bash
#
# Copyright (c) 2018, ROE (http://www.roe.ac.uk/)
# All rights reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

#
# Use the container IP address rather than the name.
# Enables clients from outside the docker-compose project to access the endpoint. 
# https://stackoverflow.com/a/42584339
# https://medium.com/@thedude_rog/running-kafka-in-a-hybrid-cloud-environment-17a8f3cfc284
# https://stackoverflow.com/questions/30880811/kafka-quickstart-advertised-host-name-gives-kafka-common-leadernotavailableexce


echo "Getting address"
address=$(
    ip -family inet addr show eth0 \
  | sed -n '
        2 {
          s/^[[:space:]]*inet \([0-9.]*\).*/\1/p
          }
        '
    )

echo "Setting address [${address}]"
export KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://${address:?}:9092


#
# Run the original Kafka container command.
echo "Running original command"
/etc/confluent/docker/run $@
